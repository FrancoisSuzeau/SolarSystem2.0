/*
AUTHOR : SUZEAU FranÃ§ois

DATE : 26/05/2021

MODULE : Application

NAMEFILE : Application.hpp

PURPOSE :   - creating OpenGL Context
            - Intialise all object of the scene
            - manage event and interaction
*/

#include "Application.hpp"

/***********************************************************************************************************************************************************************/
/*********************************************************************** Constructor and Destructor ********************************************************************/
/***********************************************************************************************************************************************************************/
Application::Application(int width, int height, SDL_Window *window): m_state(nullptr), m_window(window), m_data_manager(), m_engines_manager(), progress(0.f)
//m_setting(), m_overlay(), camera(nullptr)
{
    if (m_state == nullptr)
    {
        m_state = new Engine::State(width, height, 45.0);
        assert(m_state);

    }

    m_data_manager.setConfigs(m_state);
}

Application::~Application()
{

}

/***********************************************************************************************************************************************************************/
/*************************************************************************************** cleanAll **********************************************************************/
/***********************************************************************************************************************************************************************/
void Application::cleanAll()
{
    if (m_state != nullptr)
    {
        m_state->clean();
        delete m_state;
        m_state = nullptr;
    }

    m_data_manager.clean(PREFERENCE);
    m_data_manager.clean(BODIESDATA);
    m_data_manager.clean(SHADERSDATA);
    m_data_manager.clean(SPACESHIPSDATA);
    m_data_manager.clean(SKYBOXPATHS);

    m_engines_manager.cleanAllEngines();
    /*
    if(camera != nullptr)
    {
        delete camera;
        camera = nullptr;
    }

    m_setting.clean();
    m_overlay.clean();

    */
}

///***********************************************************************************************************************************************************************/
///*********************************************************************************** initEngines ***********************************************************************/
///***********************************************************************************************************************************************************************/
void Application::initEngines()
{
    for (std::string function : {"createBuffers", "manageFramebuffers", "renderers"})
    {
        this->initFrame();

        glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);

        if (m_state != nullptr)
        {
            m_engines_manager.initRenderEngine(m_state, function, progress / 87.f);
        }

        this->endFrame();
        SDL_Delay(1500);
        progress++;
    }
    m_engines_manager.initDiscreteSimEngine();
    SDL_Delay(1500);
}

///***********************************************************************************************************************************************************************/
///*************************************************************************************** startLoop *********************************************************************/
///***********************************************************************************************************************************************************************/
void Application::loadAssets()
{   
    int nb_bodies = m_data_manager.getNbBodies();
    int nb_shaders = m_data_manager.getNbShaders();
    int nb_musics = m_data_manager.getNbMusics();

    std::vector<std::string> skybox_paths = m_data_manager.getSkyboxPath();
    for (std::vector<std::string>::iterator it = skybox_paths.begin(); it != skybox_paths.end(); it++)
    {
        this->sendToEngine(progress, it[0], "skybox");
        progress++;
    }
    for (int current_load = 0; current_load < nb_bodies; current_load++)
    {
        for (std::string texture_type : {"surface", "cloud", "night", "normal"})
        {
            std::string path = m_data_manager.getTexturePath(current_load, texture_type);

            if (path.size() != 0)
            {
                this->sendToEngine(progress, path, "body_texture");
            }
            progress++;
        }
    }
    for (int current_load = 0; current_load < nb_shaders; current_load++)
    {
        m_data_manager.setShaderPaths(current_load);
        std::string text = "Currently loading " + m_data_manager.getShaderPaths()["name"] + " shader ...";
        this->sendToEngine(progress, text, "shader");
        progress++;
        //SDL_Delay(1000);
    }

    std::string spaceship_path = m_data_manager.setAndGetSpaceshipPath(m_state->getSpaceshipName());
    this->sendToEngine(progress, spaceship_path, "spaceship");
    progress++;
    //SDL_Delay(1000);

    std::string music_path = m_data_manager.setAndGetMusicPath(0);
    this->sendToEngine(progress, music_path, "music");

    
}


void Application::sendToEngine(float& progress, std::string text, std::string type)
{
    this->initFrame();

    glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);

    m_engines_manager.addToEngine(progress / 88.f, text, type, m_data_manager);

    this->endFrame();
}

///***********************************************************************************************************************************************************************/
///*************************************************************************************** mainLoop **********************************************************************/
///***********************************************************************************************************************************************************************/
void Application::mainLoop()
{
    while(!m_state->getTerminate())
    {
            this->fpsCalculation(BEGIN);
//
//        /******************************************************************* MANAGING EVENTS ******************************************************************/
            m_state->listenEvents();
            //        //=====================================================================================================================================================
            //
            //        /******************************************************************* MANAGING CHANGES *****************************************************************/
            //            this->makeAllChanges();
            //        //=====================================================================================================================================================
            //
            //        /******************************************************************* RENDER AUDIO **********************************************************************/
            //            this->renderAudio();
                            m_engines_manager.manageAudioEngine(m_data_manager);
            //        //======================================================================================================================================================
            //
            //        /******************************************************************* IMGUI PIPELINE ********************************************************************/
                        this->initFrame();
            //        //======================================================================================================================================================
            //
            //        /******************************************************************* DEPTH MAP CALCULATION *************************************************************/
            glClearColor(0.1f, 0.1f, 0.1f, 1.0f);
            glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
            glEnable(GL_BLEND);
            glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
            //            
            //            m_data_manager.setPass(DEPTH_FBO);
            //            this->renderIntoFramebuffer(DEPTH_FBO);
            //        //======================================================================================================================================================
            //
            //        /******************************************************************* RENDER SYSTEM *********************************************************************/
            //            m_data_manager.setPass(COLOR_FBO);
            //            this->renderIntoFramebuffer(COLOR_FBO);
            //        //======================================================================================================================================================
            //
            //        /******************************************************************* RENDER SETTINGS *******************************************************************/
            //            this->renderSettings();
            //        //======================================================================================================================================================
            //
            //        /******************************************************************* RENDER OVERLAY ********************************************************************/
            //            this->renderOverlay();
                        m_engines_manager.manageGUI(m_data_manager);
            //        //======================================================================================================================================================
            //
            //        /******************************************************************* RENDER OVERLAY ********************************************************************/
            //            this->renderNameAndInfo();
            //        //======================================================================================================================================================
            //
            //        /******************************************************************* RENDER FLARE ********************************************************************/
            //            this->renderFlare();
            //        //======================================================================================================================================================
            //
            //            m_framebuffer->unbindFramebuffer();
            //            m_framebuffer->renderFrame(m_data_manager);
            //
            //        /******************************************************************* SWAPPING WINDOWS *******************************************************************/
                        this->endFrame();
            //        //=======================================================================================================================================================
            //
            this->fpsCalculation(END);
    }
}

///***********************************************************************************************************************************************************************/
///******************************************************************************** renderIntoFramebuffer ***********************************************************************/
///***********************************************************************************************************************************************************************/
//void Application::renderIntoFramebuffer(int type)
//{
//    m_framebuffer->bindFramebuffer(type);
//    
//
//        if(m_data_manager.getPass() == DEPTH_FBO)
//        {
//            glViewport(0, 0, m_data_manager.getWidth(), m_data_manager.getWidth());
//            glClear(GL_DEPTH_BUFFER_BIT);
//            glCullFace(GL_FRONT);
//        }
//        else
//        {
//            glViewport(0, 0, m_data_manager.getWidth(), m_data_manager.getHeight());
//            glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
//        }
//
//        /******************************************************************* RENDER SCENE *********************************************************************/
//            this->renderScene();
//        //======================================================================================================================================================
//
//        if(m_data_manager.getPass() == DEPTH_FBO)
//        {
//            glCullFace(GL_BACK);
//            m_framebuffer->unbindFramebuffer();
//        }
//}
//
///***********************************************************************************************************************************************************************/
///******************************************************************************** makeAllChanges ***********************************************************************/
///***********************************************************************************************************************************************************************/
//void Application::makeAllChanges()
//{
//    if((ship != nullptr) && (m_input != nullptr))
//    {
//        if((!render_menu))
//        {
//            ship->transform(glm::vec3(0.f), m_input);
//            ship->sendToShader(m_data_manager);
//            m_data_manager.setShipPos(ship->getPosition());
//            m_data_manager.setShipOrientation(ship->getOrientation());
//        }
//        ship->loadModelShip(m_data_manager);
//    }
//
//    if((camera != nullptr) && (m_input != nullptr))
//    {
//        camera->setDistFromShip(m_data_manager.getDistancteFromShip());
//        camera->move(m_input, render_menu);
//        m_data_manager.setViewMat(camera->getViewMatrix());
//        m_data_manager.setCamPos(camera->getPosition());
//    }
//
//    if(m_skybox != nullptr)
//    {
//        m_skybox->sendToShader(m_data_manager);
//    }
//
//    if(m_solar_system != nullptr)
//    {
//        m_solar_system->makeChanges(m_data_manager);
//    }
//
//    std::vector<glm::mat4> shadowTransforms = m_data_manager.getLightSpaceMatrix();
//    glUseProgram(m_data_manager.getShader("depth_map")->getProgramID());
//        for(int i = 0; i < 6; ++i)
//        {
//            m_data_manager.getShader("depth_map")->setMat4("shadowMatrices[" + std::to_string(i) + "]", shadowTransforms[i]);
//        }
//        m_data_manager.getShader("depth_map")->setFloat("far_plane", m_data_manager.getFar());
//        m_data_manager.getShader("depth_map")->setVec3("sunPos", m_data_manager.getSunPos());
//    glUseProgram(0);
//}
//
///***********************************************************************************************************************************************************************/
///*********************************************************************************** renderAudio ***********************************************************************/
///***********************************************************************************************************************************************************************/
//void Application::renderAudio()
//{
//    if(m_audio != nullptr)
//    {
//        m_audio->changeVolume(m_data_manager.getVolume());
//        m_audio->pause(m_data_manager.getPause());
//        m_audio->updateTrack(m_data_manager);
//    }
//}
//
///***********************************************************************************************************************************************************************/
///*********************************************************************************** fpsCalculation ********************************************************************/
///***********************************************************************************************************************************************************************/
void Application::fpsCalculation(int moment)
{
    
    switch (moment)
    {
        case BEGIN:
            start_loop = SDL_GetTicks();
            break;

        case END:
            end_loop = SDL_GetTicks();
            time_past = end_loop - start_loop;
            if (time_past < frame_rate)
            {
                SDL_Delay(frame_rate - time_past);
            }
            frame_rate = 1000 / m_state->getFps();
            break;

        default:
            break;
    }
}



/***********************************************************************************************************************************************************************/
/********************************************************************************** initFrame **************************************************************************/
/***********************************************************************************************************************************************************************/
void Application::initFrame()
{
    ImGui_ImplOpenGL3_NewFrame();
    ImGui_ImplSDL2_NewFrame();
    ImGui::NewFrame();
}

/***********************************************************************************************************************************************************************/
/*********************************************************************************** endFrame **************************************************************************/
/***********************************************************************************************************************************************************************/
void Application::endFrame()
{
    ImGui::Render();
    ImGui_ImplOpenGL3_RenderDrawData(ImGui::GetDrawData());
    SDL_GL_SwapWindow(m_window);
}

/***********************************************************************************************************************************************************************/
/*********************************************************************************** renderScene ***********************************************************************/
/***********************************************************************************************************************************************************************/
//void Application::renderOverlay()
//{
//    if(m_data_manager.getRenderOverlay())
//    {
//        glm::mat4 save = m_data_manager.getViewMat();
//        m_data_manager.lockView(glm::vec3(0.0f, 0.0f, -1.1f), glm::vec3(0.0f, 0.0f, 0.0f), glm::vec3(0.0f, 1.0f, 0.0f));
//        m_overlay.renderEdges(m_data_manager);
//        m_data_manager.resetViewMat(save);
//
//        m_overlay.renderAppInfo();
//
//        m_overlay.renderMusicInfo(m_data_manager);
//
//        //m_overlay->displayNavigation(render_data);
//    }
//}
//
///***********************************************************************************************************************************************************************/
///*********************************************************************************** renderScene ***********************************************************************/
///***********************************************************************************************************************************************************************/
//void Application::renderScene()
//{   
//
//    if(!render_menu && (m_data_manager.getPass() == COLOR_FBO))
//    {
//        ship->drawSpaceship(m_data_manager);
//    }
//    if(m_skybox != nullptr)
//    {
//        m_skybox->render(m_data_manager);
//    }
//
//    if(m_solar_system != nullptr)
//    {
//        m_solar_system->render(m_data_manager);
//        m_solar_system->renderRing(m_data_manager);
//        m_solar_system->renderAtmosphere(m_data_manager);
//    }
//}
//
///***********************************************************************************************************************************************************************/
///*********************************************************************************** manage_state **********************************************************************/
///***********************************************************************************************************************************************************************/
void Application::manage_state()
{
    m_state->listenEvents();
}

///***********************************************************************************************************************************************************************/
///*********************************************************************************** renderNameAndInfo *********************************************************************/
///***********************************************************************************************************************************************************************/
//void Application::renderNameAndInfo()
//{
//    m_solar_system->renderNameAndInfo(m_data_manager);
//}
//
///***********************************************************************************************************************************************************************/
///*********************************************************************************** renderFlare *********************************************************************/
///***********************************************************************************************************************************************************************/
//void Application::renderFlare()
//{
//    m_solar_system->renderFlareSun(m_data_manager);
//}

/***********************************************************************************************************************************************************************/
/********************************************************************************* renderParticles *********************************************************************/
/***********************************************************************************************************************************************************************/
// void Application::renderParticles(RenderData &render_data)
// {
//    if(m_particule_manager != nullptr)
//    {
//        m_particule_manager->renderParticules(render_data, ship, m_input);
//    }
// }